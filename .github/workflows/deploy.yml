# .github/workflows/deploy.yml
name: Deploy to Production (Hetzner)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    # ======================
    # SETUP PHASE
    # ======================
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    - name: Install Docker Compose
      run: |
        mkdir -p ~/.docker/cli-plugins/
        curl -SL https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-linux-x86_64 \
          -o ~/.docker/cli-plugins/docker-compose
        chmod +x ~/.docker/cli-plugins/docker-compose

    # ======================
    # BUILD PHASE
    # ======================
    - name: Generate production .env
      run: |
        cat <<EOF > .env.prod
        ENV=production
        DEBUG=false
        TYPESENSE_API_KEY=${{ secrets.PROD_TYPESENSE_API_KEY }}
        TYPESENSE_HOST=typesense
        TYPESENSE_PORT=8108
        TYPESENSE_PROTOCOL=http
        TYPESENSE_DATA_DIR=/data/typesense
        BACKEND_PORT=8000
        FRONTEND_PORT=8001
        DOMAIN=${{ secrets.PROD_DOMAIN }}
        EOF

    - name: Build production images
      env:
        TYPESENSE_API_KEY: ${{ secrets.PROD_TYPESENSE_API_KEY }}
        TYPESENSE_DATA_DIR: /data/typesense
        TYPESENSE_HOST: typesense
        TYPESENSE_PORT: 8108
        TYPESENSE_PROTOCOL: http
        DOMAIN: ${{ secrets.PROD_DOMAIN }}
      run: |
        # Create temporary .env file for build
        cat <<EOF > .env.tmp
        TYPESENSE_API_KEY=$TYPESENSE_API_KEY
        TYPESENSE_DATA_DIR=$TYPESENSE_DATA_DIR
        TYPESENSE_HOST=$TYPESENSE_HOST
        TYPESENSE_PORT=$TYPESENSE_PORT
        TYPESENSE_PROTOCOL=$TYPESENSE_PROTOCOL
        DOMAIN=$DOMAIN
        EOF
        
        docker compose -f docker-compose.prod.yml --env-file .env.tmp build
        rm .env.tmp

    # ======================
    # DEPLOYMENT PHASE
    # ======================
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

    - name: Transfer files to server
      run: |
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='.github' \
          -e "ssh -o StrictHostKeyChecking=no" \
          . deploy@${{ secrets.HETZNER_SERVER_IP }}:~/app/

    - name: Initialize certificates
      run: |
        ssh -T -o StrictHostKeyChecking=no deploy@${{ secrets.HETZNER_SERVER_IP }} << 'EOT'
        cd ~/app
        
        # 1. Create .env file with all required variables
        cat <<EOF > .env
        TYPESENSE_API_KEY=${TYPESENSE_API_KEY}
        TYPESENSE_DATA_DIR=/data/typesense
        TYPESENSE_HOST=typesense
        TYPESENSE_PORT=8108
        TYPESENSE_PROTOCOL=http
        DOMAIN=${DOMAIN}
        EOF
        
        # 2. Start only the database first with health checks
        docker compose -f docker-compose.prod.yml up -d typesense
        
        # 3. Wait for Typesense to be fully ready
        while ! docker compose -f docker-compose.prod.yml exec typesense \
          curl -sf http://localhost:8108/health >/dev/null; do
          echo "Waiting for Typesense to start..."
          sleep 5
        done
        
        # 4. Start nginx alone for ACME challenges
        docker compose -f docker-compose.prod.yml up -d nginx
        
        # 5. Generate DH parameters in background (non-blocking)
        mkdir -p nginx/config/dhparam
        if [ ! -f nginx/config/dhparam/dhparam.pem ]; then
          openssl dhparam -out nginx/config/dhparam/dhparam.pem 2048 &
        fi
        
        # 6. Run certbot with correct syntax
        docker compose -f docker-compose.prod.yml run --rm certbot \
          sh -c "certbot certonly --webroot -w /var/www/certbot \
          --email nina@tymyrddin.dev --agree-tos --non-interactive \
          --force-renewal \
          -d ${DOMAIN} -d www.${DOMAIN}"
        
        # 7. Complete full deployment
        docker compose -f docker-compose.prod.yml up -d --build
        
        # 8. Verify DH params completed
        if [ ! -f nginx/config/dhparam/dhparam.pem ]; then
          echo "Waiting for DH parameters to generate..."
          wait # for background process
        fi
        
        # 9. Final nginx reload
        docker compose -f docker-compose.prod.yml exec nginx nginx -s reload
        EOT
      env:
        TYPESENSE_API_KEY: ${{ secrets.PROD_TYPESENSE_API_KEY }}
        DOMAIN: ${{ secrets.PROD_DOMAIN }}
      timeout-minutes: 20

    # ======================
    # VERIFICATION PHASE
    # ======================
    - name: Verify deployment
      run: |
        ssh -T -o StrictHostKeyChecking=no deploy@${{ secrets.HETZNER_SERVER_IP }} << 'EOT'
        cd ~/app
        echo "=== Running Containers ==="
        docker compose -f docker-compose.prod.yml ps -a
        
        echo "\n=== Typesense Logs ==="
        docker compose -f docker-compose.prod.yml logs typesense
        
        echo "\n=== SSL Certificate ==="
        docker compose -f docker-compose.prod.yml exec nginx \
          openssl x509 -noout -text -in /etc/letsencrypt/live/$DOMAIN/cert.pem | \
          grep -E 'Issuer:|Not Before:|Not After:|DNS:'
        
        echo "\n=== HTTPS Test ==="
        curl -I https://$DOMAIN
        EOT
      env:
        DOMAIN: ${{ secrets.PROD_DOMAIN }}
