# .github/workflows/deploy.yml
name: Deploy to Production (Hetzner)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    # ======================
    # SETUP & BUILD
    # ======================
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    - name: Install Docker Compose
      run: |
        mkdir -p ~/.docker/cli-plugins/
        curl -SL https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-linux-x86_64 \
          -o ~/.docker/cli-plugins/docker-compose
        chmod +x ~/.docker/cli-plugins/docker-compose

    - name: Generate production .env
      run: |
        cat <<EOF > .env.prod
        ENV=production
        DEBUG=false
        TYPESENSE_API_KEY=${{ secrets.PROD_TYPESENSE_API_KEY }}
        TYPESENSE_HOST=typesense
        TYPESENSE_PORT=8108
        TYPESENSE_PROTOCOL=http
        TYPESENSE_DATA_DIR=/data/typesense
        BACKEND_PORT=8000
        FRONTEND_PORT=8001
        DOMAIN=${{ secrets.PROD_DOMAIN }}
        EOF

    - name: Build production images
      env:
        TYPESENSE_API_KEY: ${{ secrets.PROD_TYPESENSE_API_KEY }}
      run: |
        docker compose -f docker-compose.prod.yml build

    # ======================
    # DEPLOYMENT
    # ======================
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

    - name: Transfer files to server
      run: |
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='node_modules' \
          -e "ssh -o StrictHostKeyChecking=no" \
          . deploy@${{ secrets.HETZNER_SERVER_IP }}:~/app/

    - name: Initialize SSL certificates
      run: |
        ssh -o StrictHostKeyChecking=no deploy@${{ secrets.HETZNER_SERVER_IP }} << 'EOF'
        cd ~/app
        
        # Generate DH parameters if missing
        if [ ! -f nginx/config/dhparam/dhparam.pem ]; then
          mkdir -p nginx/config/dhparam
          openssl dhparam -out nginx/config/dhparam/dhparam.pem 4096
        fi
        
        # Stop existing containers
        docker compose -f docker-compose.prod.yml down
        
        # Start temporary nginx
        docker compose -f docker-compose.prod.yml up -d nginx
        
        # Obtain certificates
        docker compose -f docker-compose.prod.yml run --rm certbot \
          certonly --webroot -w /var/www/certbot \
          --email nina@tymyrddin.dev --agree-tos --non-interactive \
          --force-renewal \
          -d ${DOMAIN} -d www.${DOMAIN}
        
        # Full deployment
        docker compose -f docker-compose.prod.yml up -d --build
        EOF
      env:
        DOMAIN: ${{ secrets.PROD_DOMAIN }}

    # ======================
    # VERIFICATION
    # ======================
    - name: Verify deployment
      run: |
        ssh -o StrictHostKeyChecking=no deploy@${{ secrets.HETZNER_SERVER_IP }} << 'EOF'
        echo "=== System Verification ==="
        
        # Docker status
        docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        
        # SSL verification
        echo "\n=== SSL Certificate ==="
        docker exec nginx openssl x509 -noout -text -in /etc/letsencrypt/live/${DOMAIN}/cert.pem | \
          grep -E 'Issuer:|Not Before:|Not After:|DNS:'
        
        # Connection test
        echo "\n=== HTTPS Connection ==="
        curl -Ikv https://${DOMAIN} 2>&1 | grep -E 'SSL|HTTP'
        
        # Security headers
        echo "\n=== Security Headers ==="
        curl -sI https://${DOMAIN} | grep -E 'Strict-Transport-Security|Content-Security-Policy|X-Content-Type-Options'
        
        # Nginx config test
        echo "\n=== Nginx Configuration ==="
        docker exec nginx nginx -t
        EOF
      env:
        DOMAIN: ${{ secrets.PROD_DOMAIN }}
